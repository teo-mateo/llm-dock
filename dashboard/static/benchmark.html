<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark - LLM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .terminal-output {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .param-tooltip {
            position: absolute;
            left: 0;
            bottom: calc(100% + 6px);
            z-index: 50;
            width: 280px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            line-height: 1.5;
            color: #cbd5e1;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .param-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 16px;
            border: 6px solid transparent;
            border-top-color: #475569;
        }
        .param-ref-row:hover .param-tooltip {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<!-- Toast container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<div class="max-w-7xl mx-auto p-6">

    <!-- Header -->
    <div class="mb-6">
        <a href="/" class="text-blue-400 hover:text-blue-300 text-sm mb-3 inline-block">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back to Dashboard
        </a>
        <div class="flex items-center gap-3 mb-1">
            <h1 class="text-2xl font-bold">
                Benchmark: <span id="service-name" class="text-yellow-400">—</span>
            </h1>
            <span id="service-status-badge" class="px-2 py-0.5 rounded text-xs font-semibold bg-gray-700 text-gray-400">
                Unknown
            </span>
        </div>
        <p class="text-gray-400 text-sm">
            Model: <span id="model-path" class="text-gray-300 font-mono">—</span>
        </p>
    </div>

    <!-- Two-column: Parameters (left) + Reference (right) -->
    <div class="flex flex-col lg:flex-row gap-4 mb-4">

        <!-- Left column: Parameters + Command Preview + Run -->
        <div id="left-column" class="flex-1 min-w-0">
            <!-- Parameters -->
            <div class="bg-gray-800 rounded-lg p-5 mb-4">
                <h2 class="text-lg font-semibold mb-3">
                    <i class="fa-solid fa-sliders mr-2 text-gray-400"></i>Parameters
                </h2>
                <div id="params-container" class="flex flex-col gap-2 mb-3">
                    <!-- Dynamic rows inserted here -->
                </div>
                <div class="flex gap-2">
                    <button onclick="resetToDefaults()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded">
                        <i class="fa-solid fa-rotate-left mr-1"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Command Preview -->
            <div class="bg-gray-800 rounded-lg p-5 mb-4">
                <h2 class="text-sm font-semibold text-gray-400 mb-2">Command Preview</h2>
                <div id="command-preview" class="font-mono text-sm text-green-400 bg-gray-950 rounded p-3 break-all">
                    llama-bench ...
                </div>
            </div>

            <!-- Run Button -->
            <div class="flex gap-3">
                <button id="run-btn" onclick="runBenchmark()" class="bg-green-600 hover:bg-green-700 px-5 py-2.5 rounded font-semibold text-sm">
                    <i class="fa-solid fa-play mr-1"></i> Run Benchmark
                </button>
            </div>
        </div>

        <!-- Right column: Parameter Reference -->
        <div class="lg:w-80 xl:w-96 flex-shrink-0">
            <div class="bg-gray-800 rounded-lg p-4 lg:sticky lg:top-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-gray-300">
                        <i class="fa-solid fa-book mr-1.5 text-gray-400"></i>Parameter Reference
                    </h2>
                    <a href="https://github.com/ggml-org/llama.cpp/blob/master/tools/llama-bench/README.md"
                       target="_blank" class="text-gray-500 hover:text-gray-300 text-xs" title="llama-bench docs">
                        <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </a>
                </div>
                <div id="param-ref-body">
                    <div class="relative mb-3">
                        <i class="fa-solid fa-magnifying-glass absolute left-2.5 top-2 text-gray-500 text-xs"></i>
                        <input type="text" id="param-search" placeholder="Search flags..."
                            oninput="filterParamRef()"
                            class="w-full bg-gray-700 border border-gray-600 rounded pl-7 pr-3 py-1.5 text-xs font-mono focus:outline-none focus:border-blue-500 placeholder-gray-500">
                    </div>
                    <div class="flex gap-3 text-[10px] text-gray-500 mb-2 px-1">
                        <span><span class="inline-block w-1.5 h-1.5 rounded-full bg-orange-400 mr-1"></span>Benchmark-only (not applied to service)</span>
                        <span><span class="inline-block w-1.5 h-1.5 rounded-full bg-yellow-400 mr-1"></span>Runtime param</span>
                    </div>
                    <div id="param-ref-list" class="overflow-y-auto space-y-0.5 text-xs">
                        <!-- Populated by JS -->
                    </div>
                    <div id="param-ref-empty" class="text-gray-500 text-xs py-4 text-center hidden">
                        No matching parameters.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Live Output (full width, collapsible) -->
    <div class="bg-gray-800 rounded-lg p-5 mb-6">
        <div class="flex items-center justify-between cursor-pointer select-none" onclick="toggleLiveOutput()">
            <h2 class="text-lg font-semibold">
                <i id="live-output-chevron" class="fa-solid fa-chevron-down mr-1.5 text-gray-500 text-xs transition-transform rotate-[-90deg]"></i>
                <i class="fa-solid fa-terminal mr-2 text-gray-400"></i>Live Output
            </h2>
            <span id="run-status-badge" class="px-2 py-0.5 rounded text-xs font-semibold bg-gray-700 text-gray-400">
                Idle
            </span>
        </div>
        <div id="live-output-wrapper" class="hidden mt-3">
            <div id="live-output" class="terminal-output bg-gray-950 rounded p-4 h-64 overflow-y-auto text-gray-400">
                Waiting for benchmark run...
            </div>
        </div>
    </div>

    <!-- History (full width) -->
    <div class="bg-gray-800 rounded-lg p-5">
        <h2 class="text-lg font-semibold mb-3">
            <i class="fa-solid fa-clock-rotate-left mr-2 text-gray-400"></i>History
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 text-left border-b border-gray-700">
                        <th class="pb-2 pr-3">Date</th>
                        <th class="pb-2 pr-3">PP t/s</th>
                        <th class="pb-2 pr-3">TG t/s</th>
                        <th class="pb-2 pr-3">Key Params</th>
                        <th class="pb-2 pr-3">Status</th>
                        <th class="pb-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <!-- Dynamic rows -->
                </tbody>
            </table>
        </div>
        <p id="history-empty" class="text-gray-500 text-sm mt-3 hidden">No benchmark history yet.</p>
    </div>

</div>

<script>
// ── State ──────────────────────────────────────────────
const urlParams = new URLSearchParams(window.location.search);
const serviceName = urlParams.get('service') || 'unknown-service';
let modelPath = '';
let serviceDefaults = {};

let isRunning = false;
let currentRunId = null;
let pollInterval = null;
const BENCHMARK_ONLY_FLAGS = new Set(['-m', '-p', '-n', '-r', '-o', '-pg', '-d', '-oe', '-v', '--delay', '--list-devices']);
const AUTO_ADDED_FLAGS = new Set(['-m', '-o']);
const SAFE_DEFAULTS = { '-p': '512', '-n': '128', '-r': '3' };

let historyData = [];

// ── Auth / API ─────────────────────────────────────────
const API_BASE = window.location.origin;

function getToken() {
    return localStorage.getItem('dashboard_token');
}

async function fetchAPI(endpoint, options = {}) {
    const token = getToken();
    if (!token) {
        showToast('Not authenticated. Please log in from the dashboard first.', 'error');
        throw new Error('Not authenticated');
    }
    const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers,
        },
    });
    if (response.status === 401) {
        showToast('Authentication expired. Please log in from the dashboard.', 'error');
        throw new Error('Auth expired');
    }
    return response;
}

// ── Init ───────────────────────────────────────────────
document.getElementById('service-name').textContent = serviceName;

async function initPage() {
    try {
        // Load service info
        const svcResp = await fetchAPI(`/api/services/${serviceName}`);
        if (svcResp.ok) {
            const svcData = await svcResp.json();
            const config = svcData.config || {};
            modelPath = config.model_path || '';
            document.getElementById('model-path').textContent = modelPath || 'Unknown';
        }

        // Load service status
        try {
            const statusResp = await fetchAPI('/api/services');
            if (statusResp.ok) {
                const statusData = await statusResp.json();
                const svc = (statusData.services || []).find(s => s.name === serviceName);
                if (svc) {
                    const badge = document.getElementById('service-status-badge');
                    if (svc.status === 'running') {
                        badge.innerHTML = '<span class="text-green-400">&#9679;</span> Running';
                        badge.className = 'px-2 py-0.5 rounded text-xs font-semibold bg-green-900 text-green-300';
                    } else {
                        badge.innerHTML = '<span class="text-gray-400">&#9679;</span> Stopped';
                        badge.className = 'px-2 py-0.5 rounded text-xs font-semibold bg-gray-700 text-gray-400';
                    }
                }
            }
        } catch (e) { /* status fetch is non-critical */ }

        // Load params: most recent run first, then safe defaults
        const histResp = await fetchAPI(`/api/benchmarks?service_name=${encodeURIComponent(serviceName)}&limit=1`);
        if (histResp.ok) {
            const histData = await histResp.json();
            if (histData.runs && histData.runs.length > 0) {
                loadParams(histData.runs[0].params || {});
            } else {
                loadParams(SAFE_DEFAULTS);
            }
        } else {
            loadParams(SAFE_DEFAULTS);
        }

        // Load full history
        await refreshHistory();
    } catch (e) {
        console.error('Init error:', e);
    }

    await loadParamReference();
    renderParamRef();
}

async function loadServiceDefaults() {
    try {
        const resp = await fetchAPI(`/api/benchmarks/service-defaults/${encodeURIComponent(serviceName)}`);
        if (resp.ok) {
            const data = await resp.json();
            serviceDefaults = data.params || {};
            if (!modelPath) {
                modelPath = data.model_path || '';
                document.getElementById('model-path').textContent = modelPath || 'Unknown';
            }
            loadParams(serviceDefaults);
        }
    } catch (e) {
        console.error('Failed to load service defaults:', e);
    }
}

initPage();

// Keep param ref height synced with left column
new ResizeObserver(() => updateParamRefHeight()).observe(document.getElementById('left-column'));

// ── Parameter Reference Data ───────────────────────────
let PARAM_REFERENCE = [];

async function loadParamReference() {
    try {
        const resp = await fetchAPI('/api/flag-metadata/llamacpp_bench');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const flags = data.optional_flags || {};
        PARAM_REFERENCE = Object.values(flags).map(f => {
            const isLong = f.cli.startsWith('--');
            return {
                cat:  f.category || 'Other',
                flag: isLong ? '' : f.cli,
                long: isLong ? f.cli : '',
                desc: f.description || '',
                def:  f.default || '',
                tip:  f.tip || '',
            };
        });
    } catch (e) {
        console.error('Failed to load param reference:', e);
        PARAM_REFERENCE = [];
    }
}

// ── Parameter Management ───────────────────────────────
function addParamRow(flag, value, isEmpty = false) {
    const container = document.getElementById('params-container');
    const row = document.createElement('div');
    const isBench = BENCHMARK_ONLY_FLAGS.has(flag);
    row.className = `flex gap-2 items-center param-row border-l-2 rounded-r pl-1 ${isBench ? 'border-orange-500/50' : 'border-transparent'}`;
    if (isEmpty) row.dataset.empty = '1';
    row.innerHTML = `
        <input type="text" value="${escapeAttr(flag)}" placeholder="-flag"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm w-28 font-mono focus:outline-none focus:border-blue-500 ${isBench ? 'text-orange-400' : ''}"
            oninput="onParamInput(this); updateParamRowStyle(this); updatePreview()">
        <input type="text" value="${escapeAttr(value)}" placeholder="value (empty = boolean flag)"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm flex-1 font-mono focus:outline-none focus:border-blue-500"
            oninput="onParamInput(this); updatePreview()">
        ${isBench ? '<span class="bench-badge text-[9px] uppercase tracking-wide font-semibold bg-orange-500/15 text-orange-400 px-1.5 py-0.5 rounded whitespace-nowrap">bench</span>' : ''}
        <button onclick="removeParamRow(this)" class="text-red-400 hover:text-red-300 px-2 py-1 ${isEmpty ? 'invisible' : ''}" title="Remove">
            <i class="fa-solid fa-xmark"></i>
        </button>
    `;
    const emptyRow = container.querySelector('.param-row[data-empty="1"]');
    if (emptyRow && !isEmpty) {
        container.insertBefore(row, emptyRow);
    } else {
        container.appendChild(row);
    }
    updatePreview();
    return row;
}

function ensureEmptyRow() {
    const container = document.getElementById('params-container');
    const emptyRow = container.querySelector('.param-row[data-empty="1"]');
    if (!emptyRow) {
        addParamRow('', '', true);
    }
}

function onParamInput(input) {
    const row = input.closest('.param-row');
    if (row.dataset.empty === '1') {
        // User started typing in the empty row — promote it to a regular row
        delete row.dataset.empty;
        row.querySelector('button').classList.remove('invisible');
        ensureEmptyRow();
    }
}

function removeParamRow(btn) {
    const row = btn.closest('.param-row');
    if (row.dataset.empty === '1') return; // can't delete the empty row
    row.remove();
    updatePreview();
    ensureEmptyRow();
}

function updateParamRowStyle(input) {
    const row = input.closest('.param-row');
    const flag = input.value.trim();
    const isBench = BENCHMARK_ONLY_FLAGS.has(flag);

    // Update row border
    row.classList.toggle('border-orange-500/50', isBench);
    row.classList.toggle('border-transparent', !isBench);

    // Update flag input color
    input.classList.toggle('text-orange-400', isBench);

    // Toggle bench badge
    const existingBadge = row.querySelector('.bench-badge');
    if (isBench && !existingBadge) {
        const badge = document.createElement('span');
        badge.className = 'bench-badge text-[9px] uppercase tracking-wide font-semibold bg-orange-500/15 text-orange-400 px-1.5 py-0.5 rounded whitespace-nowrap';
        badge.textContent = 'bench';
        row.querySelector('button').insertAdjacentElement('beforebegin', badge);
    } else if (!isBench && existingBadge) {
        existingBadge.remove();
    }
}

function getParams() {
    const rows = document.querySelectorAll('.param-row:not([data-empty="1"])');
    const params = {};
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const flag = inputs[0].value.trim();
        const value = inputs[1].value.trim();
        if (flag) {
            params[flag] = value;
        }
    });
    return params;
}

function getParamsArray() {
    const rows = document.querySelectorAll('.param-row:not([data-empty="1"])');
    const params = [];
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const flag = inputs[0].value.trim();
        const value = inputs[1].value.trim();
        if (flag) {
            params.push({ flag, value });
        }
    });
    return params;
}

function resetToDefaults() {
    loadParams(SAFE_DEFAULTS);
    showToast('Parameters reset to defaults', 'info');
}

function loadParams(params) {
    document.getElementById('params-container').innerHTML = '';
    // Benchmark-only flags first, then the rest
    const entries = Object.entries(params);
    const bench = entries.filter(([flag]) => BENCHMARK_ONLY_FLAGS.has(flag));
    const rest = entries.filter(([flag]) => !BENCHMARK_ONLY_FLAGS.has(flag));
    bench.concat(rest).forEach(([flag, value]) => addParamRow(flag, value));
    ensureEmptyRow();
}

// ── Command Preview ────────────────────────────────────
function updatePreview() {
    const params = getParamsArray();
    let cmd = `llama-bench -m ${modelPath} -o json`;
    params.forEach(p => {
        cmd += ` ${p.flag}`;
        if (p.value) cmd += ` ${p.value}`;
    });
    document.getElementById('command-preview').textContent = cmd;
}

// ── Run Benchmark ──────────────────────────────────────
async function runBenchmark() {
    if (isRunning) return;

    const params = getParams();
    const runBtn = document.getElementById('run-btn');
    const output = document.getElementById('live-output');
    const badge = document.getElementById('run-status-badge');

    runBtn.disabled = true;
    runBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Starting...';
    runBtn.className = 'bg-gray-600 px-5 py-2.5 rounded font-semibold text-sm cursor-not-allowed';

    // Auto-expand live output
    document.getElementById('live-output-wrapper').classList.remove('hidden');
    document.getElementById('live-output-chevron').classList.remove('rotate-[-90deg]');

    try {
        const resp = await fetchAPI('/api/benchmarks', {
            method: 'POST',
            body: JSON.stringify({ service_name: serviceName, params }),
        });

        const data = await resp.json();

        if (!resp.ok) {
            const errMsg = data.error?.message || data.error || 'Failed to start benchmark';
            showToast(errMsg, 'error');
            resetRunButton();
            return;
        }

        currentRunId = data.id;
        isRunning = true;

        badge.textContent = 'Running';
        badge.className = 'px-2 py-0.5 rounded text-xs font-semibold bg-yellow-900 text-yellow-300';
        runBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Running...';
        output.textContent = `Benchmark started (${currentRunId}).\nWaiting for results...\n`;
        output.className = 'terminal-output bg-gray-950 rounded p-4 h-64 overflow-y-auto text-green-400';

        showToast('Benchmark started', 'info');
        startPolling(currentRunId);
    } catch (e) {
        showToast('Failed to start benchmark: ' + e.message, 'error');
        resetRunButton();
    }
}

function startPolling(runId) {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => pollRunStatus(runId), 2000);
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

async function pollRunStatus(runId) {
    try {
        const resp = await fetchAPI(`/api/benchmarks/${runId}`);
        if (!resp.ok) return;

        const run = await resp.json();
        const output = document.getElementById('live-output');
        const badge = document.getElementById('run-status-badge');

        if (run.status === 'running') {
            badge.textContent = 'Running';
            badge.className = 'px-2 py-0.5 rounded text-xs font-semibold bg-yellow-900 text-yellow-300';
        } else if (run.status === 'completed') {
            stopPolling();
            isRunning = false;
            currentRunId = null;

            let resultText = `Benchmark completed.\n`;
            if (run.pp_avg_ts != null) resultText += `\nPrompt Processing: ${run.pp_avg_ts.toFixed(2)} t/s`;
            if (run.pp_stddev_ts != null) resultText += ` (stddev: ${run.pp_stddev_ts.toFixed(2)})`;
            if (run.tg_avg_ts != null) resultText += `\nText Generation:   ${run.tg_avg_ts.toFixed(2)} t/s`;
            if (run.tg_stddev_ts != null) resultText += ` (stddev: ${run.tg_stddev_ts.toFixed(2)})`;
            if (run.build_commit) resultText += `\n\nbuild: ${run.build_commit}`;
            if (run.gpu_info) resultText += `\ngpu:   ${run.gpu_info}`;
            if (run.raw_output) {
                resultText += `\n\n--- Raw Output ---\n${run.raw_output}`;
            }

            output.textContent = resultText;
            badge.textContent = 'Completed';
            badge.className = 'px-2 py-0.5 rounded text-xs font-semibold bg-green-900 text-green-300';
            resetRunButton();
            showToast('Benchmark completed', 'success');
            await refreshHistory();
        } else if (run.status === 'failed' || run.status === 'cancelled') {
            stopPolling();
            isRunning = false;
            currentRunId = null;

            output.textContent = `Benchmark ${run.status}.\n\n${run.error_message || ''}`;
            output.className = 'terminal-output bg-gray-950 rounded p-4 h-64 overflow-y-auto text-red-400';
            badge.textContent = run.status === 'failed' ? 'Failed' : 'Cancelled';
            badge.className = 'px-2 py-0.5 rounded text-xs font-semibold bg-red-900 text-red-300';
            resetRunButton();
            showToast(`Benchmark ${run.status}`, 'error');
            await refreshHistory();
        }
    } catch (e) {
        console.error('Poll error:', e);
    }
}

function resetRunButton() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = false;
    runBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> Run Benchmark';
    runBtn.className = 'bg-green-600 hover:bg-green-700 px-5 py-2.5 rounded font-semibold text-sm';
}

// ── History Table ──────────────────────────────────────
async function refreshHistory() {
    try {
        const resp = await fetchAPI(`/api/benchmarks?service_name=${encodeURIComponent(serviceName)}&limit=50`);
        if (resp.ok) {
            const data = await resp.json();
            historyData = (data.runs || []).map(r => ({
                id: r.id,
                date: r.created_at ? r.created_at.replace('T', ' ').substring(0, 19) : '',
                pp_ts: r.pp_avg_ts,
                tg_ts: r.tg_avg_ts,
                params: r.params || {},
                status: r.status,
            }));
            renderHistory();
        }
    } catch (e) {
        console.error('Failed to refresh history:', e);
    }
}

function renderHistory() {
    const tbody = document.getElementById('history-body');
    const empty = document.getElementById('history-empty');

    if (historyData.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }
    empty.classList.add('hidden');

    tbody.innerHTML = historyData.map(row => {
        const statusIcons = {
            completed: '<span class="text-green-400"><i class="fa-solid fa-check"></i> Completed</span>',
            failed: '<span class="text-red-400"><i class="fa-solid fa-xmark"></i> Failed</span>',
            running: '<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin"></i> Running</span>',
            pending: '<span class="text-gray-400"><i class="fa-solid fa-clock"></i> Pending</span>',
            cancelled: '<span class="text-gray-400"><i class="fa-solid fa-ban"></i> Cancelled</span>',
        };
        const statusBadge = statusIcons[row.status] || `<span class="text-gray-400">${escapeHtml(row.status)}</span>`;

        const allParams = Object.entries(row.params || {}).map(([flag, val]) =>
            val ? `${flag} ${val}` : flag
        ).join('  ');

        return `
            <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                <td class="py-2.5 pr-3 text-gray-300 text-xs whitespace-nowrap">${escapeHtml(row.date)}</td>
                <td class="py-2.5 pr-3 font-mono ${row.pp_ts ? 'text-white' : 'text-gray-500'}">${row.pp_ts ? row.pp_ts.toFixed(1) : '—'}</td>
                <td class="py-2.5 pr-3 font-mono ${row.tg_ts ? 'text-white' : 'text-gray-500'}">${row.tg_ts ? row.tg_ts.toFixed(1) : '—'}</td>
                <td class="py-2.5 pr-3 text-gray-400 text-xs font-mono">${escapeHtml(allParams)}</td>
                <td class="py-2.5 pr-3 text-xs">${statusBadge}</td>
                <td class="py-2.5">
                    <div class="flex gap-1">
                        <button onclick="rerunBenchmark('${row.id}')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" title="Re-run with these params">
                            <i class="fa-solid fa-rotate-right"></i> Re-run
                        </button>
                        ${row.status === 'completed' ? `
                        <button onclick="applyToService('${row.id}')" class="text-xs bg-blue-700 hover:bg-blue-600 px-2 py-1 rounded" title="Apply config to service">
                            <i class="fa-solid fa-upload"></i> Apply
                        </button>` : ''}
                        <button onclick="deleteRun('${row.id}')" class="text-xs bg-red-700 hover:bg-red-600 px-2 py-1 rounded" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function rerunBenchmark(id) {
    const row = historyData.find(r => r.id === id);
    if (!row) return;
    loadParams(row.params);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    showToast('Parameters loaded from history run', 'info');
}

async function applyToService(id) {
    const row = historyData.find(r => r.id === id);
    if (!row) return;

    const DENYLIST = ['-p', '-n', '-r', '-o', '-m'];
    const applicable = {};
    const skipped = [];
    Object.entries(row.params).forEach(([flag, value]) => {
        if (DENYLIST.includes(flag)) skipped.push(flag);
        else applicable[flag] = value;
    });

    if (Object.keys(applicable).length === 0) {
        showToast('No applicable parameters to apply (all are benchmark-only flags)', 'warning');
        return;
    }

    const appliedStr = Object.entries(applicable)
        .map(([k, v]) => v ? `${k} ${v}` : k)
        .join(', ');

    if (!confirm(`Apply to ${serviceName}?\n\nParams: ${appliedStr}\nSkipped: ${skipped.join(', ')}\n\nService must be restarted for changes to take effect.`)) {
        return;
    }

    try {
        const resp = await fetchAPI(`/api/benchmarks/${id}/apply`, { method: 'PUT' });
        const data = await resp.json();
        if (resp.ok) {
            showToast(data.message || 'Configuration applied', 'success');
        } else {
            showToast(data.error?.message || 'Failed to apply', 'error');
        }
    } catch (e) {
        showToast('Failed to apply: ' + e.message, 'error');
    }
}

async function deleteRun(id) {
    try {
        const resp = await fetchAPI(`/api/benchmarks/${id}`, { method: 'DELETE' });
        if (resp.ok) {
            showToast('Benchmark run deleted', 'info');
            await refreshHistory();
        } else {
            const data = await resp.json();
            showToast(data.error?.message || 'Failed to delete', 'error');
        }
    } catch (e) {
        showToast('Failed to delete: ' + e.message, 'error');
    }
}

// ── Toast Notifications ────────────────────────────────
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const colors = {
        success: 'bg-green-800 border-green-600',
        info: 'bg-blue-800 border-blue-600',
        warning: 'bg-yellow-800 border-yellow-600',
        error: 'bg-red-800 border-red-600',
    };
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type] || colors.info} border rounded px-4 py-2 text-sm max-w-sm shadow-lg`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ── Utilities ──────────────────────────────────────────
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function escapeAttr(str) {
    return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ── Parameter Reference Panel ──────────────────────────

function toggleLiveOutput() {
    const wrapper = document.getElementById('live-output-wrapper');
    const chevron = document.getElementById('live-output-chevron');
    wrapper.classList.toggle('hidden');
    chevron.classList.toggle('rotate-[-90deg]');
}

function toggleParamRef() {
    const body = document.getElementById('param-ref-body');
    const chevron = document.getElementById('param-ref-chevron');
    body.classList.toggle('hidden');
    chevron.classList.toggle('rotate-[-90deg]');
    updateParamRefHeight();
}

function updateParamRefHeight() {
    const list = document.getElementById('param-ref-list');
    const body = document.getElementById('param-ref-body');
    if (!body || body.classList.contains('hidden')) return;

    const leftCol = document.getElementById('left-column');
    const refPanel = body.closest('.bg-gray-800');
    if (!leftCol || !refPanel) return;

    // Measure left column content height (not stretched flex height)
    let leftContentHeight = 0;
    for (const child of leftCol.children) {
        leftContentHeight += child.offsetHeight + 16; // mb-4 gap
    }
    leftContentHeight -= 16; // no gap after last child

    // Chrome = header + search + legend (everything in the ref panel except the list)
    list.style.maxHeight = 'none';
    const chrome = refPanel.offsetHeight - list.offsetHeight;
    const maxList = leftContentHeight - chrome;
    list.style.maxHeight = Math.max(120, maxList) + 'px';
}

function renderParamRef(filter = '') {
    const list = document.getElementById('param-ref-list');
    const empty = document.getElementById('param-ref-empty');
    const q = filter.toLowerCase();

    let html = '';
    let currentCat = '';
    let hasResults = false;

    PARAM_REFERENCE.forEach(p => {
        const flagText = p.flag || p.long;
        const searchable = `${p.flag} ${p.long} ${p.desc} ${p.cat}`.toLowerCase();
        if (q && !searchable.includes(q)) return;

        hasResults = true;

        if (p.cat !== currentCat) {
            currentCat = p.cat;
            html += `<div class="text-gray-500 uppercase tracking-wider text-[10px] font-semibold mt-2.5 mb-1 px-1">${escapeHtml(currentCat)}</div>`;
        }

        const isBenchOnly = BENCHMARK_ONLY_FLAGS.has(p.flag) || BENCHMARK_ONLY_FLAGS.has(p.long);
        const isAutoAdded = AUTO_ADDED_FLAGS.has(p.flag) || AUTO_ADDED_FLAGS.has(p.long);
        const flagColor = isBenchOnly ? 'text-orange-400' : 'text-yellow-400';
        const rowBorder = isBenchOnly ? 'border-l-2 border-orange-500/40' : 'border-l-2 border-transparent';
        const benchBadge = isBenchOnly ? ' <span class="text-[9px] uppercase tracking-wide font-semibold bg-orange-500/15 text-orange-400 px-1 py-0.5 rounded">' + (isAutoAdded ? 'auto' : 'bench') + '</span>' : '';

        const primaryFlag = escapeHtml(p.flag || p.long);
        const secondaryFlag = p.flag && p.long ? ` <span class="text-gray-600">${escapeHtml(p.long)}</span>` : '';
        const defBadge = p.def ? `<span class="text-gray-600 ml-auto pl-2 whitespace-nowrap">${escapeHtml(p.def)}</span>` : '';

        const clickable = !isAutoAdded;
        const tooltip = p.tip ? `<div class="param-tooltip">${p.tip}</div>` : '';
        html += `
            <div class="param-ref-row group rounded-r px-2 py-1.5 relative ${clickable ? 'hover:bg-gray-700/50 cursor-pointer' : 'opacity-60'} transition-colors ${rowBorder}"
                 ${clickable ? `onclick="useRefParam('${escapeAttr(p.flag || p.long)}', '${escapeAttr(p.def)}')"` : ''}
                 ${!p.tip ? `title="${isAutoAdded ? 'Auto-added, cannot be modified' : (isBenchOnly ? 'Benchmark-only — not applied to service config. ' : '') + 'Click to add ' + escapeAttr(flagText) + ' to parameters'}"` : ''}>
                <div class="flex items-center gap-1">
                    <span class="${flagColor} font-mono font-semibold">${primaryFlag}</span>${secondaryFlag}${benchBadge}${defBadge}
                </div>
                <div class="text-gray-400 leading-snug mt-0.5">${escapeHtml(p.desc)}</div>
                ${tooltip}
            </div>`;
    });

    list.innerHTML = html;
    empty.classList.toggle('hidden', hasResults);
}

function filterParamRef() {
    const q = document.getElementById('param-search').value.trim();
    renderParamRef(q);
}

function useRefParam(flag, defaultValue) {
    // Check if this flag already exists in the param rows
    const rows = document.querySelectorAll('.param-row');
    for (const row of rows) {
        const flagInput = row.querySelector('input');
        if (flagInput && flagInput.value.trim() === flag) {
            flagInput.focus();
            showToast(`${flag} is already in your parameters`, 'info');
            return;
        }
    }
    addParamRow(flag, defaultValue);
    showToast(`Added ${flag}`, 'success');
}
</script>

</body>
</html>
