<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom radio button styling */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #6b7280;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            position: relative;
        }
        input[type="radio"]:checked {
            border-color: #22c55e;
            background: #22c55e;
        }
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1f2937;
        }
        .param-tooltip {
            position: fixed;
            z-index: 9999;
            width: 280px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            line-height: 1.5;
            color: #cbd5e1;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .param-ref-row:hover .param-tooltip {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold mb-6">LLM Dashboard Login</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4 relative">
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <div class="relative">
                        <input
                            type="password"
                            id="token-input"
                            placeholder="Enter your password"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 pr-10 py-2 text-white focus:outline-none focus:border-blue-500"
                            required
                        >
                        <button
                            type="button"
                            id="toggle-password"
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 focus:outline-none"
                            aria-label="Show password"
                            aria-pressed="false"
                        >
                            <i class="fa-regular fa-eye" id="password-icon"></i>
                        </button>
                    </div>
                </div>
                <button
                    type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold"
                >
                    Login
                </button>
                <p id="login-error" class="text-red-400 text-sm mt-3 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logs-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-8">
        <div class="bg-gray-800 rounded-lg w-full h-full border border-gray-700 flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <h2 class="text-2xl font-bold" id="logs-modal-title">Container Logs</h2>
                    <div id="logs-polling-indicator" class="w-3 h-3 rounded-full bg-green-500 opacity-0 transition-opacity"></div>
                </div>
                <button onclick="closeLogsModal()" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="flex-1 overflow-auto p-6">
                <pre id="logs-content" class="text-sm font-mono text-gray-300 whitespace-pre-wrap">Loading logs...</pre>
            </div>
            <div class="p-4 border-t border-gray-700 text-sm text-gray-400">
                <span id="logs-info">Last updated: Never</span>
            </div>
        </div>
    </div>

    <!-- Create Service Modal -->
    <div id="create-service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-8">
        <div id="create-service-modal-content" class="bg-gray-800 rounded-lg w-full max-w-7xl border border-gray-700 max-h-[90vh] flex flex-col relative">
            <div id="create-service-modal-header" class="flex justify-between items-center p-6 border-b border-gray-700 cursor-move select-none flex-shrink-0">
                <h2 id="modal-title" class="text-2xl font-bold">Create New Service</h2>
                <button onclick="closeCreateServiceModal()" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <form id="create-service-form" class="p-6 space-y-6 overflow-y-auto flex-1">
                <!-- Model & GPU Info Display -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-900 p-4 rounded border border-gray-700">
                        <h3 class="font-bold mb-2">Selected Model</h3>
                        <p id="modal-model-name" class="text-sm text-gray-300"></p>
                        <p id="modal-model-size" class="text-xs text-gray-500"></p>
                    </div>
                    <div id="gpu-info-panel" class="bg-gray-900 p-4 rounded border border-gray-700">
                        <h3 class="font-bold mb-2"><i class="fa-solid fa-microchip mr-1"></i> GPU</h3>
                        <p id="modal-gpu-name" class="text-sm text-gray-300">Loading...</p>
                        <p id="modal-gpu-vram" class="text-xs text-gray-500"></p>
                    </div>
                </div>

                <!-- Engine Selection -->
                <div>
                    <label class="block text-sm font-medium mb-2">Engine <span class="text-red-400">*</span></label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="engine" value="llamacpp" class="mr-2" required>
                            <span>llama.cpp (GGUF models)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="engine" value="vllm" class="mr-2">
                            <span>vllm (safetensors/bin)</span>
                        </label>
                    </div>
                </div>

                <!-- Service Configuration -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Service Name <span class="text-red-400">*</span></label>
                        <input type="text" id="service-name" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Port <span class="text-red-400">*</span></label>
                        <input type="number" id="service-port" min="3300" max="3400" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500" required>
                    </div>
                </div>

                <!-- Model Path (llama.cpp only) -->
                <div id="model-path-group" class="hidden">
                    <label class="block text-sm font-medium mb-2">Model Path (container) <span class="text-red-400">*</span></label>

                    <!-- File selector for GGUF files -->
                    <div id="gguf-file-selector" class="hidden mb-2">
                        <div class="text-xs text-gray-400 mb-1">Select a GGUF file:</div>
                        <div id="gguf-file-list" class="bg-gray-800 border border-gray-600 rounded max-h-40 overflow-y-auto">
                            <!-- Files will be populated here -->
                        </div>
                    </div>

                    <input type="text" id="model-path" placeholder="/hf-cache/hub/..." class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                    <p id="model-path-hint" class="text-xs text-gray-500 mt-1 hidden"></p>
                </div>

                <!-- Model Name (vllm only) -->
                <div id="model-name-group" class="hidden">
                    <label class="block text-sm font-medium mb-2">HuggingFace Model Name</label>
                    <input type="text" id="model-hf-name" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500" readonly>
                </div>

                <!-- Parameters + Reference (two-column layout) -->
                <div id="params-section" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <label class="flex items-center gap-2">
                            <span class="text-sm font-medium">Parameters</span>
                            <span id="params-count" class="text-xs text-gray-500">(0 configured)</span>
                        </label>
                        <div class="flex gap-2">
                            <button type="button" onclick="openCopyFromModal()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs font-semibold">
                                <i class="fa-solid fa-copy mr-1"></i>Copy from...
                            </button>
                            <button type="button" onclick="resetServiceParams()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs font-semibold">
                                <i class="fa-solid fa-rotate-left mr-1"></i>Reset
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <!-- Left: param rows -->
                        <div class="flex-1 min-w-0">
                            <div id="dynamic-params-container" class="flex flex-col gap-2">
                                <!-- Parameter rows inserted here dynamically -->
                            </div>
                        </div>
                        <!-- Right: parameter reference panel -->
                        <div id="param-ref-panel" class="w-72 flex-shrink-0">
                            <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-xs font-semibold text-gray-300">
                                        <i class="fa-solid fa-book mr-1 text-gray-400"></i>Parameter Reference
                                    </h3>
                                </div>
                                <div class="relative mb-2">
                                    <i class="fa-solid fa-magnifying-glass absolute left-2.5 top-2 text-gray-500 text-xs"></i>
                                    <input type="text" id="serve-param-search" placeholder="Search flags..."
                                        oninput="filterServeParamRef()"
                                        class="w-full bg-gray-700 border border-gray-600 rounded pl-7 pr-3 py-1.5 text-xs font-mono focus:outline-none focus:border-blue-500 placeholder-gray-500">
                                </div>
                                <div id="serve-param-ref-list" class="overflow-y-auto space-y-0.5 text-xs max-h-72 min-h-72">
                                    <!-- Populated by JS -->
                                </div>
                                <div id="serve-param-ref-empty" class="text-gray-500 text-xs py-4 text-center hidden">
                                    No matching parameters.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Key -->
                <div>
                    <label class="block text-sm font-medium mb-2">API Key (optional, auto-generated if empty)</label>
                    <div class="flex gap-2">
                        <input type="text" id="api-key" placeholder="Leave empty to auto-generate" class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                        <button type="button" id="use-global-api-key-btn" onclick="useGlobalApiKey()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-semibold whitespace-nowrap hidden" title="Set to global API key">
                            <i class="fa-solid fa-globe mr-1"></i>Use Global
                        </button>
                    </div>
                </div>

                <!-- Command Preview -->
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <h3 class="font-bold mb-2 text-sm">Command Preview</h3>
                    <pre id="command-preview" class="text-xs font-mono text-gray-300 whitespace-pre-wrap overflow-x-auto max-h-64 overflow-y-auto">Loading...</pre>
                </div>

                <!-- Error Display -->
                <div id="create-service-error" class="bg-red-900 border border-red-700 rounded p-3 text-red-200 text-sm hidden"></div>
            </form>
            <!-- Actions - Fixed at bottom -->
            <div class="flex gap-4 justify-end border-t border-gray-700 p-6 flex-shrink-0">
                <button type="button" onclick="closeCreateServiceModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold">
                    Cancel
                </button>
                <button type="submit" form="create-service-form" id="create-service-submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold">
                    <i class="fa-solid fa-plus mr-2"></i>Create Service
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Service Modal -->
    <div id="delete-service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg w-full max-w-md border border-gray-700 shadow-2xl">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center gap-3 mb-2">
                    <div class="bg-red-600 rounded-full p-3">
                        <i class="fa-solid fa-trash text-white text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold">Delete Service</h2>
                </div>
            </div>
            <div class="p-6">
                <p class="text-gray-300 mb-2">Are you sure you want to delete this service?</p>
                <p class="text-xl font-semibold text-white mb-4" id="delete-service-name"></p>
                <div class="bg-yellow-900 bg-opacity-30 border border-yellow-700 rounded p-3 mb-4">
                    <p class="text-yellow-200 text-sm">
                        <i class="fa-solid fa-exclamation-triangle mr-2"></i>
                        This will remove the service from the database and docker-compose.yml
                    </p>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex gap-3 justify-end">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold">
                    Cancel
                </button>
                <button id="delete-service-confirm" onclick="confirmDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded font-semibold">
                    <i class="fa-solid fa-trash mr-2"></i>Delete Service
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Service Modal -->
    <div id="rename-service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg w-full max-w-md border border-gray-700 shadow-2xl">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center gap-3 mb-2">
                    <div class="bg-blue-600 rounded-full p-3">
                        <i class="fa-solid fa-pen text-white text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold">Rename Service</h2>
                </div>
            </div>
            <div class="p-6">
                <p class="text-gray-400 text-sm mb-1">Current name</p>
                <p class="text-white font-semibold font-mono mb-4" id="rename-service-old-name"></p>
                <label class="block text-gray-400 text-sm mb-1" for="rename-service-input">New name</label>
                <input
                    type="text"
                    id="rename-service-input"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded font-mono text-white focus:outline-none focus:border-blue-500"
                    placeholder="new-service-name"
                    onkeydown="if(event.key==='Enter'){event.preventDefault();confirmRename()}"
                >
                <p class="text-xs text-gray-500 mt-2">Alphanumeric, hyphens, and underscores only. Service must be stopped.</p>
                <p id="rename-service-error" class="text-red-400 text-sm mt-2 hidden"></p>
            </div>
            <div class="p-6 border-t border-gray-700 flex gap-3 justify-end">
                <button onclick="closeRenameModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold">
                    Cancel
                </button>
                <button id="rename-service-confirm" onclick="confirmRename()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                    <i class="fa-solid fa-pen mr-2"></i>Rename
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Service Modal -->
    <div id="preview-service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg w-full max-w-3xl border border-gray-700 shadow-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-600 rounded-full p-3">
                            <i class="fa-solid fa-code text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Service YAML</h2>
                    </div>
                    <button onclick="closePreviewModal()" class="text-gray-400 hover:text-white">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <p class="text-gray-400 mt-2" id="preview-service-name"></p>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <pre id="preview-yaml" class="bg-gray-900 p-4 rounded font-mono text-sm overflow-x-auto"></pre>
            </div>
            <div class="p-6 border-t border-gray-700 flex gap-3 justify-end">
                <button onclick="closePreviewModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold">
                    Close
                </button>
                <button onclick="copyPreviewYaml()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                    <i class="fa-solid fa-copy mr-2"></i>Copy
                </button>
            </div>
        </div>
    </div>

    <!-- Copy From Modal (high z-index) -->
    <div id="copy-from-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden p-8">
        <div class="bg-gray-800 rounded-lg w-full max-w-md border border-gray-700">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h2 class="text-xl font-bold">Copy Parameters From</h2>
                <button onclick="closeCopyFromModal()" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-400 mb-4">Select a service to copy its parameters. This will replace all current parameters.</p>
                <div id="copy-from-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Service list will be inserted here -->
                </div>
                <div id="copy-from-empty" class="text-gray-500 text-sm hidden">
                    No other services of this engine type found.
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end">
                <button onclick="closeCopyFromModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="app" class="container mx-auto p-6 hidden">
        <header class="mb-8">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-3xl font-bold">LLM Service Dashboard</h1>
                    <div id="image-metadata" class="text-xs text-gray-500 mt-1"></div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="global-api-key-display" class="hidden flex items-center gap-2 bg-gray-800 px-3 py-2 rounded border border-gray-700">
                        <span class="text-xs text-gray-400">API Key (default):</span>
                        <span id="global-api-key-value" class="text-sm font-mono text-gray-300"></span>
                        <button onclick="copyGlobalApiKey()" class="text-blue-400 hover:text-blue-300 ml-1" title="Copy global API key">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-semibold">
                        Logout
                    </button>
                </div>
            </div>
            <div class="flex gap-4">
                <div id="gpu-stats" class="flex-shrink-0"></div>
                <div id="gpu-graph-container" class="flex-1 bg-gray-800 rounded border border-gray-700 p-4 min-h-[120px] hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-400 font-semibold">GPU History (60s)</span>
                        <div class="flex gap-4 text-xs">
                            <span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-blue-500 inline-block"></span> Memory</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-green-500 inline-block"></span> Compute</span>
                        </div>
                    </div>
                    <canvas id="gpu-graph" class="w-full" height="80"></canvas>
                </div>
            </div>
        </header>
        <div id="services" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>

        <!-- System Info Section -->
        <section class="mt-8">
            <h2 class="text-2xl font-bold mb-4">System Information</h2>
            <div id="system-info" class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <p class="text-gray-400">Loading system information...</p>
            </div>
        </section>
    </div>

    <script src="/static/js/modal-manager.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/services.js"></script>
    <script src="/static/js/gpu.js"></script>
    <script src="/static/js/logs.js"></script>
    <script src="/static/js/system-info.js"></script>
    <script src="/static/js/service-modal/param-reference.js"></script>
    <script src="/static/js/service-modal/param-rows.js"></script>
    <script src="/static/js/service-modal/create-service.js"></script>
    <script src="/static/js/init.js"></script>
</body>
</html>
